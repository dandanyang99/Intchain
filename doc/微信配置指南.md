# 微信小程序配置指南

本文档说明如何安全地配置微信小程序的 AppId 和 AppSecret。

## 获取微信小程序凭证

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" → "开发管理" → "开发设置"
3. 在"开发者ID"部分可以看到：
   - **AppID(小程序ID)**: 已配置为 `wx9e25d31a5b4e9330`
   - **AppSecret(小程序密钥)**: 点击"生成"或"重置"获取

⚠️ **安全警告**: AppSecret 是敏感信息，切勿提交到版本控制系统！

---

## 开发环境配置

### 方法一：使用 appsettings.Development.json（当前项目使用）

1. 在 `src/Services/UserService/appsettings.Development.json` 中添加：

```json
{
  "WeChat": {
    "AppSecret": "你的实际AppSecret"
  }
}
```

2. **重要**: 确保 `appsettings.Development.json` 已添加到 `.gitignore`，避免提交敏感信息到版本控制

### 方法二：使用 .NET User Secrets

1. 在 UserService 项目目录下执行：

```bash
cd src/Services/UserService
dotnet user-secrets init
dotnet user-secrets set "WeChat:AppSecret" "你的实际AppSecret"
```

2. 验证配置：

```bash
dotnet user-secrets list
```

---

## 生产环境配置

### 方法一：使用 appsettings.Production.json（当前项目使用）

1. 在 `src/Services/UserService/appsettings.Production.json` 中添加：

```json
{
  "WeChat": {
    "AppSecret": "你的实际AppSecret"
  }
}
```

2. **重要**: 确保 `appsettings.Production.json` 已添加到 `.gitignore`，避免提交敏感信息到版本控制

3. 部署时，在服务器上创建此文件并配置实际的 AppSecret

### 方法二：使用环境变量

在服务器上设置环境变量：

**Linux/macOS:**
```bash
export WeChat__AppSecret="你的实际AppSecret"
```

**Windows:**
```powershell
$env:WeChat__AppSecret="你的实际AppSecret"
```

**Docker:**
```yaml
environment:
  - WeChat__AppSecret=你的实际AppSecret
```

### 方法二：使用 Azure Key Vault / AWS Secrets Manager

生产环境建议使用云服务商提供的密钥管理服务。

---

## 配置验证

启动 UserService 后，检查日志中是否有以下错误：

```
WeChat configuration is missing
```

如果出现此错误，说明 AppSecret 未正确配置。

---

## 前端配置

前端小程序的 AppId 已在以下位置配置：

- **manifest.json**: `"appid": "wx9e25d31a5b4e9330"`

确保前端和后端使用相同的 AppId。

---

## 测试微信登录

1. 启动 UserService（端口 5153）
2. 启动 Gateway（端口 5199）
3. 在微信开发者工具中打开小程序
4. 点击"微信快捷登录"按钮
5. 查看后端日志，确认微信 API 调用成功

---

## 常见问题

### Q: 提示"AppSecret 错误"
A: 检查 AppSecret 是否正确，是否已过期（重置后旧密钥立即失效）

### Q: 提示"code 无效"
A: 微信 code 仅5分钟有效且只能使用一次，请重新获取

### Q: 提示"频率限制"
A: 微信 API 有调用频率限制，请稍后再试

---

**文档更新时间**: 2026-01-18
