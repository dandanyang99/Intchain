# 彩票管理微信小程序 - 技术路线文档

## 项目概述

本项目是一个彩票管理微信小程序，涉及三个使用方：销售网点、彩票中心、印刷厂。实现从彩票产品发布、申请、审批、印刷、发货到物流跟踪的完整业务流程。

## 一、前端技术栈（小程序端）

### 推荐方案：**uni-app**

**理由**：
1. **跨平台能力**：基于 Vue.js，一套代码可以发布到微信小程序、H5、App等多端
2. **开发效率高**：组件化开发，丰富的UI组件库（如 uView UI）
3. **生态成熟**：文档完善，社区活跃，问题容易解决
4. **适合多角色应用**：便于实现不同角色的页面和权限控制

**备选方案**：
- **原生微信小程序**：如果只做微信小程序且团队熟悉原生开发
- **Taro**：如果团队更熟悉 React

**技术组件**：
- **框架**：uni-app 3.x
- **UI组件库**：uView UI 2.x
- **状态管理**：Vuex / Pinia
- **HTTP请求**：uni.request 封装 / axios
- **路由管理**：uni-app 内置路由

## 二、后端技术栈

### 推荐方案：**.NET Core / ASP.NET Core**

**理由**：
1. **企业级应用**：适合处理复杂的业务逻辑和审批流程
2. **性能优秀**：高并发处理能力强
3. **类型安全**：C# 强类型语言，减少运行时错误
4. **成熟的权限框架**：易于实现多角色权限管理
5. **丰富的库支持**：订单管理、库存管理等业务场景有成熟方案

**技术组件**：
- **框架**：ASP.NET Core 6.0/7.0/8.0
- **ORM**：Entity Framework Core（代码优先，便于维护）
- **认证授权**：JWT + ASP.NET Core Identity
- **API文档**：Swagger/OpenAPI
- **日志**：Serilog
- **缓存**：Redis（用于库存、会话等）
- **消息队列**（可选）：RabbitMQ（用于异步任务）

**备选方案**：
- **Node.js + Express/Nest.js**：如果团队更熟悉 JavaScript
- **Java + Spring Boot**：如果需要更大规模的企业级应用

## 三、数据库选择

### 推荐方案：**MySQL 8.0** 或 **SQL Server**

**理由**：
1. **关系型数据库**：适合订单、库存、用户等结构化数据
2. **事务支持**：保证订单流转、库存扣减的数据一致性
3. **成熟稳定**：企业级应用的标准选择

**核心数据表设计**：
- **用户表（Users）**：存储所有用户信息，包含角色标识
- **彩票中心表（LotteryCenter）**：彩票中心基本信息
- **销售网点表（SalesOutlet）**：销售网点基本信息，关联彩票中心
- **印刷厂表（PrintingFactory）**：印刷厂基本信息
- **彩票产品表（LotteryProduct）**：彩票产品信息、库存
- **申请订单表（ApplicationOrder）**：销售网点的申请订单
- **印刷订单表（PrintingOrder）**：发给印刷厂的订单
- **物流信息表（LogisticsInfo）**：物流跟踪信息
- **审批记录表（ApprovalRecord）**：审批历史记录

**辅助存储**：
- **Redis**：缓存热点数据、库存计数、会话管理
- **OSS（对象存储）**：存储图片、文件等（阿里云OSS / 腾讯云COS）

## 四、架构设计

### 推荐架构：**分层架构 + DDD（领域驱动设计）**

```
├── 表示层（Presentation Layer）
│   └── 微信小程序（uni-app）
│       ├── 销售网点端
│       ├── 彩票中心端
│       ├── 印刷厂端
│       └── 管理员端
│
├── API层（API Gateway）
│   └── ASP.NET Core Web API
│       ├── 认证授权中间件
│       ├── 异常处理中间件
│       ├── 日志中间件
│       └── RESTful API接口
│
├── 业务逻辑层（Business Logic Layer）
│   ├── 订单管理服务（OrderService）
│   ├── 库存管理服务（InventoryService）
│   ├── 审批流程服务（ApprovalService）
│   ├── 用户权限服务（UserService）
│   ├── 物流对接服务（LogisticsService）
│   └── 通知服务（NotificationService）
│
├── 数据访问层（Data Access Layer）
│   └── Entity Framework Core + Repository模式
│       ├── 仓储接口（IRepository）
│       └── 工作单元（UnitOfWork）
│
└── 基础设施层（Infrastructure Layer）
    ├── 微信API对接
    ├── 物流API对接
    ├── 缓存服务（Redis）
    ├── 日志服务（Serilog）
    └── 文件存储服务（OSS）
```

## 五、关键技术点

### 1. 微信小程序对接

**登录认证流程**：
1. 小程序调用 `wx.login()` 获取 code
2. 后端使用 code 换取 openid 和 session_key
3. 后端生成 JWT token 返回给小程序
4. 小程序后续请求携带 token

**消息推送**：
- 订单状态变更时发送模板消息通知
- 审批结果通知
- 发货通知

**支付**（如需要）：
- 微信支付接口对接

### 2. 权限管理

**基于角色的访问控制（RBAC）**：
- **管理员（Admin）**：系统配置、添加彩票中心和印刷厂
- **彩票中心（LotteryCenter）**：发布产品、审批订单、管理销售网点
- **印刷厂（PrintingFactory）**：接收印刷订单、发货、物流管理
- **销售网点（SalesOutlet）**：申请彩票、查看订单、确认收货

**实现方式**：
- 使用 ASP.NET Core 的 Policy-based Authorization
- JWT token 中包含用户角色信息
- API 接口使用 `[Authorize(Policy = "RoleName")]` 进行权限控制

### 3. 订单状态机

**申请订单状态流转**：
```
待审批 → 审批通过 → 待发货 → 已发货 → 待收货 → 已完成
       ↓
    审批拒绝
```

**印刷订单状态流转**：
```
待接单 → 生产中 → 待发货 → 已发货 → 已完成
```

**实现方式**：
- 使用状态模式（State Pattern）
- 状态变更时记录审批历史
- 状态变更时触发消息通知

### 4. 库存管理

**库存扣减策略**：
1. 彩票中心发布产品时设置总库存
2. 销售网点申请时预扣库存（待审批状态）
3. 审批通过后确认扣减，审批拒绝后释放库存
4. 使用 Redis 实现分布式锁，防止超卖

**实现方式**：
```csharp
// 使用 Redis 分布式锁
using (var redisLock = await _redisLockFactory.CreateLockAsync($"inventory:{productId}"))
{
    if (await redisLock.AcquireAsync(TimeSpan.FromSeconds(5)))
    {
        // 扣减库存逻辑
        var inventory = await _inventoryRepository.GetByProductIdAsync(productId);
        if (inventory.Available >= quantity)
        {
            inventory.Available -= quantity;
            await _inventoryRepository.UpdateAsync(inventory);
        }
    }
}
```

### 5. 物流对接

**第三方物流API**：
- 快递100（https://www.kuaidi100.com/）
- 快递鸟（https://www.kdniao.com/）

**实现方式**：
1. 印刷厂发货时填写物流公司和运单号
2. 后端异步查询物流信息
3. 定时任务更新物流状态
4. 物流状态变更时推送消息通知

### 6. 审批流程

**审批功能**：
1. 销售网点申请审批（彩票中心审批）
2. 彩票中心申请审批（印刷厂审批）

**实现方式**：
- 审批记录表记录审批历史
- 支持修改申请数量
- 审批结果通知申请方

## 六、开发工具推荐

### 开发环境
- **IDE**：Visual Studio 2022 / VS Code / Rider
- **小程序开发工具**：微信开发者工具 / HBuilderX
- **数据库管理**：Navicat / SQL Server Management Studio / DataGrip
- **API测试**：Postman / Apifox
- **Redis管理**：RedisInsight / Another Redis Desktop Manager

### 版本控制
- **版本控制**：Git
- **代码托管**：GitHub / GitLab / Gitee
- **分支策略**：Git Flow（main、develop、feature、release、hotfix）

### 项目管理
- **需求管理**：禅道 / Jira / Teambition
- **文档管理**：语雀 / Confluence / Notion

## 七、部署方案

### 服务器配置
- **云服务商**：阿里云 / 腾讯云 / 华为云
- **服务器配置**：
  - 应用服务器：2核4G（起步配置）
  - 数据库服务器：2核8G（推荐独立部署）
  - Redis服务器：1核2G（可与应用服务器共用）

### 容器化部署（推荐）
- **容器化**：Docker + Docker Compose
- **编排**：Kubernetes（大规模部署时）
- **镜像仓库**：阿里云容器镜像服务 / Harbor

### 反向代理
- **Nginx**：反向代理、负载均衡、静态资源服务
- **HTTPS**：Let's Encrypt 免费证书 / 云服务商SSL证书

### CI/CD
- **持续集成**：GitHub Actions / GitLab CI / Jenkins
- **自动化部署**：自动构建、测试、部署

### 监控和日志
- **应用监控**：Application Insights / Prometheus + Grafana
- **日志收集**：ELK Stack（Elasticsearch + Logstash + Kibana）
- **错误追踪**：Sentry

## 八、开发优先级建议

### 第一阶段：基础功能（2-3周）
1. **用户登录认证**
   - 微信授权登录
   - JWT token 生成和验证
   - 用户角色管理

2. **基础数据管理**
   - 彩票中心管理
   - 销售网点管理
   - 印刷厂管理
   - 用户管理

3. **权限控制**
   - 基于角色的权限控制
   - API接口权限验证

### 第二阶段：核心业务（3-4周）
1. **彩票产品管理**
   - 彩票产品发布
   - 产品列表查看
   - 库存管理

2. **订单申请流程**
   - 销售网点申请彩票
   - 申请订单列表
   - 订单详情查看

3. **审批流程**
   - 彩票中心审批订单
   - 修改申请数量
   - 审批记录查看

### 第三阶段：物流管理（2-3周）
1. **印刷订单管理**
   - 印刷订单生成
   - 印刷订单列表
   - 订单状态管理

2. **发货管理**
   - 印刷厂发货
   - 填写物流信息
   - 物流信息对接

3. **物流跟踪**
   - 物流信息查询
   - 物流状态更新
   - 收货确认

### 第四阶段：优化完善（2-3周）
1. **消息通知**
   - 订单状态变更通知
   - 审批结果通知
   - 发货通知

2. **数据统计**
   - 订单统计
   - 库存统计
   - 销售统计

3. **系统优化**
   - 性能优化
   - 缓存优化
   - 代码重构

## 九、技术风险和应对

### 风险1：库存超卖
**应对措施**：
- 使用 Redis 分布式锁
- 数据库层面添加库存约束
- 定期对账检查

### 风险2：订单状态不一致
**应对措施**：
- 使用数据库事务保证一致性
- 状态变更记录审计日志
- 实现幂等性接口

### 风险3：物流信息查询失败
**应对措施**：
- 实现重试机制
- 异步查询，避免阻塞
- 提供手动刷新功能

### 风险4：并发性能问题
**应对措施**：
- 使用 Redis 缓存热点数据
- 数据库查询优化和索引优化
- 实现读写分离（如需要）

### 风险5：微信接口调用限制
**应对措施**：
- 合理控制接口调用频率
- 实现接口调用缓存
- 错误处理和降级方案

## 十、开发规范

### 代码规范
- **C#**：遵循 Microsoft C# 编码规范
- **JavaScript/Vue**：遵循 ESLint + Prettier 规范
- **数据库**：遵循数据库命名规范（表名、字段名）

### API规范
- **RESTful API**：遵循 REST 设计原则
- **接口版本**：使用 URL 版本控制（如 /api/v1/）
- **响应格式**：统一的 JSON 响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

### Git提交规范
- **提交消息格式**：`<type>(<scope>): <subject>`
- **Type类型**：feat、fix、docs、style、refactor、test、chore

### 文档规范
- **API文档**：使用 Swagger 自动生成
- **数据库文档**：使用数据库设计工具生成
- **开发文档**：使用 Markdown 编写

## 十一、预算和资源评估

### 人力资源
- **前端开发**：1-2人（uni-app开发）
- **后端开发**：1-2人（.NET Core开发）
- **测试**：1人（功能测试、性能测试）
- **UI设计**：1人（小程序界面设计）

### 服务器成本（按年计算）
- **应用服务器**：约 2000-3000元/年
- **数据库服务器**：约 3000-5000元/年
- **域名和SSL证书**：约 100-500元/年
- **OSS存储**：约 500-1000元/年
- **总计**：约 6000-10000元/年

### 第三方服务
- **微信小程序认证**：300元/年
- **物流API**：根据调用量计费
- **短信服务**（如需要）：根据发送量计费

## 十二、后续扩展建议

### 功能扩展
1. **数据分析**：销售数据分析、趋势预测
2. **移动端App**：基于 uni-app 编译为 iOS/Android App
3. **管理后台**：Web端管理后台（Vue3 + Element Plus）
4. **支付功能**：在线支付、账户余额管理
5. **积分系统**：销售积分、兑换奖励

### 技术升级
1. **微服务架构**：当业务规模扩大时，拆分为微服务
2. **消息队列**：引入 RabbitMQ/Kafka 处理异步任务
3. **搜索引擎**：引入 Elasticsearch 实现全文搜索
4. **大数据分析**：引入数据仓库和BI工具

---

**文档版本**：1.0
**创建时间**：2026-01-18
**最后更新**：2026-01-18
**维护人员**：开发团队
