# 彩票管理系统 - 部署方案

## 文档信息

- **项目名称**：Intchain 彩票印刷物流管理系统
- **文档版本**：1.0
- **创建日期**：2026-01-18
- **适用环境**：生产环境、测试环境

## 一、部署架构

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡（Nginx）                       │
│                    https://api.example.com                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   API网关（Ocelot Gateway）                   │
│                    端口：5000（内部）                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      后端微服务集群                            │
│  UserService:5001 | OrderService:5002 | InventoryService:5003│
│  ApprovalService:5004 | LogisticsService:5005 | NotificationService:5006│
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                 │
│         MySQL 8.0 (主从)  |  Redis 7.x (主从)               │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 服务器配置

| 服务器 | 配置 | 数量 | 用途 |
|--------|------|------|------|
| 应用服务器 | 4核8G | 2台 | 运行网关和微服务 |
| 数据库服务器 | 4核16G | 2台 | MySQL主从 |
| Redis服务器 | 2核4G | 2台 | Redis主从 |
| Nginx服务器 | 2核4G | 1台 | 负载均衡和反向代理 |

## 二、环境配置

### 2.1 操作系统

- **系统**：Ubuntu 22.04 LTS 或 CentOS 8
- **用户**：创建专用用户 `intchain`
- **防火墙**：配置必要的端口开放

### 2.2 软件环境

**应用服务器**：
- .NET 8.0 Runtime
- Docker 24.x（可选，用于容器化部署）
- Supervisor（进程管理）

**数据库服务器**：
- MySQL 8.0
- 配置文件：`/etc/mysql/my.cnf`

**Redis服务器**：
- Redis 7.x
- 配置文件：`/etc/redis/redis.conf`

**Nginx服务器**：
- Nginx 1.24+
- SSL证书（Let's Encrypt 或商业证书）

### 2.3 端口规划

| 服务 | 端口 | 访问权限 |
|------|------|---------|
| Nginx HTTPS | 443 | 公网 |
| Nginx HTTP | 80 | 公网（重定向到443） |
| API Gateway | 5000 | 内网 |
| UserService | 5001 | 内网 |
| OrderService | 5002 | 内网 |
| InventoryService | 5003 | 内网 |
| ApprovalService | 5004 | 内网 |
| LogisticsService | 5005 | 内网 |
| NotificationService | 5006 | 内网 |
| MySQL | 3306 | 内网 |
| Redis | 6379 | 内网 |

## 三、部署步骤

### 3.1 数据库部署

**MySQL主从配置**：

```bash
# 主库配置 (my.cnf)
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-format=ROW
max_connections=1000

# 从库配置 (my.cnf)
[mysqld]
server-id=2
relay-log=mysql-relay-bin
read_only=1
```

**创建数据库和用户**：

```sql
CREATE DATABASE intchain CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'intchain'@'%' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON intchain.* TO 'intchain'@'%';
FLUSH PRIVILEGES;
```

**执行数据库迁移**：

```bash
cd /app/intchain
dotnet ef database update
```

### 3.2 Redis部署

**Redis主从配置**：

```bash
# 主库配置 (redis.conf)
bind 0.0.0.0
port 6379
requirepass strong_password
maxmemory 2gb
maxmemory-policy allkeys-lru

# 从库配置 (redis.conf)
replicaof master_ip 6379
masterauth strong_password
```

### 3.3 应用服务部署

**方式一：直接部署**

```bash
# 1. 上传发布包
scp -r publish/* intchain@server:/app/intchain/

# 2. 配置appsettings.json
cd /app/intchain
vi appsettings.Production.json

# 3. 配置Supervisor
vi /etc/supervisor/conf.d/intchain-gateway.conf
vi /etc/supervisor/conf.d/intchain-userservice.conf
# ... 其他服务

# 4. 启动服务
supervisorctl reread
supervisorctl update
supervisorctl start all
```

**方式二：Docker部署**

```bash
# 1. 构建镜像
docker build -t intchain/gateway:latest ./Gateway
docker build -t intchain/userservice:latest ./UserService
# ... 其他服务

# 2. 使用Docker Compose部署
docker-compose up -d
```

### 3.4 Nginx配置

**Nginx配置文件**：

```nginx
upstream api_gateway {
    server 192.168.1.10:5000;
    server 192.168.1.11:5000;
}

server {
    listen 80;
    server_name api.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    location / {
        proxy_pass http://api_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 四、监控和运维

### 4.1 日志管理

**日志位置**：
- 应用日志：`/var/log/intchain/`
- Nginx日志：`/var/log/nginx/`
- MySQL日志：`/var/log/mysql/`

**日志轮转配置**：

```bash
# /etc/logrotate.d/intchain
/var/log/intchain/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 intchain intchain
}
```

### 4.2 监控指标

**系统监控**：
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量

**应用监控**：
- 服务健康状态
- API响应时间
- 请求成功率
- 错误日志

**数据库监控**：
- 连接数
- 慢查询
- 主从延迟
- 锁等待

### 4.3 健康检查

**服务健康检查接口**：

```bash
# 检查网关健康状态
curl http://localhost:5000/health

# 检查各个微服务健康状态
curl http://localhost:5001/health  # UserService
curl http://localhost:5002/health  # OrderService
# ... 其他服务
```

## 五、备份和恢复

### 5.1 数据库备份

**每日自动备份脚本**：

```bash
#!/bin/bash
# /opt/scripts/mysql_backup.sh

BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="backup_user"
MYSQL_PASSWORD="backup_password"

# 全量备份
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --all-databases \
  > $BACKUP_DIR/full_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/full_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

**配置定时任务**：

```bash
# crontab -e
0 2 * * * /opt/scripts/mysql_backup.sh
```

### 5.2 数据恢复

**恢复数据库**：

```bash
# 解压备份文件
gunzip full_backup_20260118_020000.sql.gz

# 恢复数据
mysql -u root -p < full_backup_20260118_020000.sql
```

### 5.3 Redis备份

**Redis持久化配置**：

```bash
# redis.conf
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfilename "appendonly.aof"
```

## 六、故障处理

### 6.1 常见问题

**服务无法启动**：
1. 检查端口是否被占用：`netstat -tlnp | grep 5000`
2. 检查配置文件是否正确
3. 查看日志文件：`tail -f /var/log/intchain/error.log`

**数据库连接失败**：
1. 检查MySQL服务状态：`systemctl status mysql`
2. 检查防火墙规则
3. 验证数据库用户权限

**Redis连接失败**：
1. 检查Redis服务状态：`systemctl status redis`
2. 检查Redis密码配置
3. 验证网络连接

### 6.2 应急预案

**服务器宕机**：
1. 切换到备用服务器
2. 更新Nginx配置，移除故障服务器
3. 通知运维团队

**数据库故障**：
1. 主库故障：提升从库为主库
2. 从库故障：修复后重新配置主从复制

**性能问题**：
1. 检查慢查询日志
2. 分析Redis缓存命中率
3. 查看服务器资源使用情况

---

**文档版本**：1.0
**最后更新**：2026-01-18
