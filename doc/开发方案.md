# 彩票管理系统 - 开发方案

## 文档信息

- **项目名称**：Intchain 彩票印刷物流管理系统
- **文档版本**：1.0
- **创建日期**：2026-01-18
- **技术栈**：uni-app 3.x + Ocelot + ASP.NET Core 8.0 + MySQL 8.0

## 一、项目概述

### 1.1 项目背景

本项目旨在开发一个彩票印刷物流管理系统，通过微信小程序实现彩票中心、销售网点、印刷厂三方的业务协同，实现从彩票产品发布、申请、审批、印刷、发货到物流跟踪的完整业务流程。

### 1.2 业务流程

```
彩票中心发布产品 → 销售网点申请 → 彩票中心审批
→ 印刷厂印刷 → 发货配送 → 物流跟踪 → 确认收货
```

### 1.3 用户角色

- **管理员（Admin）**：系统配置、添加彩票中心和印刷厂
- **彩票中心（LotteryCenter）**：发布产品、审批订单、管理销售网点
- **印刷厂（PrintingFactory）**：接收印刷订单、发货、物流管理
- **销售网点（SalesOutlet）**：申请彩票、查看订单、确认收货

### 1.4 技术选型

| 层次 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 前端 | uni-app | 3.x | 跨平台小程序框架 |
| UI组件 | uView UI | 2.x | UI组件库 |
| 网关 | Ocelot | 最新稳定版 | .NET API网关 |
| 后端 | ASP.NET Core | 8.0 | 微服务框架 |
| ORM | Entity Framework Core | 8.0 | 数据访问框架 |
| 数据库 | MySQL | 8.0 | 关系型数据库 |
| 缓存 | Redis | 7.x | 缓存和分布式锁 |
| 对象存储 | 阿里云OSS | - | 文件存储 |

## 二、技术架构设计

### 2.1 整体架构

采用**微服务架构 + API网关**模式：

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层（uni-app 3.x）                      │
│         销售网点端 | 彩票中心端 | 印刷厂端 | 管理员端          │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                   API网关层（Ocelot Gateway）                 │
│  路由转发 | 负载均衡 | 认证授权 | 限流熔断 | 日志记录        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              后端服务层（ASP.NET Core 8.0 微服务）            │
│  用户服务 | 订单服务 | 库存服务 | 审批服务 | 物流服务 | 通知服务 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                数据层（MySQL 8.0 + Redis 7.x）               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 网关层设计

**Ocelot API Gateway 功能**：

1. **路由转发**：将前端请求转发到对应的后端服务
2. **负载均衡**：支持多实例服务的负载均衡
3. **认证授权**：统一的JWT token验证
4. **限流熔断**：防止服务过载和雪崩
5. **请求聚合**：聚合多个服务的响应
6. **缓存策略**：缓存不常变化的数据
7. **日志记录**：记录所有请求日志

### 2.3 微服务层设计

**服务划分原则**：按业务领域划分，每个服务独立部署和扩展。

| 服务名称 | 端口 | 职责 | 数据库 |
|---------|------|------|--------|
| UserService | 5001 | 用户认证、角色权限管理 | 共享MySQL |
| OrderService | 5002 | 申请订单、印刷订单管理 | 共享MySQL |
| InventoryService | 5003 | 彩票产品、库存管理 | 共享MySQL |
| ApprovalService | 5004 | 审批流程、审批记录 | 共享MySQL |
| LogisticsService | 5005 | 物流信息、第三方对接 | 共享MySQL |
| NotificationService | 5006 | 消息推送、通知管理 | 共享MySQL |

**服务间通信**：
- 同步通信：HTTP/REST API
- 异步通信：消息队列（可选，后期扩展）

### 2.4 数据访问层设计

**Entity Framework Core Code First 模式**：

```csharp
// DbContext 示例
public class IntchainDbContext : DbContext
{
    public DbSet<User> Users { get; set; }
    public DbSet<LotteryCenter> LotteryCenters { get; set; }
    public DbSet<SalesOutlet> SalesOutlets { get; set; }
    public DbSet<PrintingFactory> PrintingFactories { get; set; }
    public DbSet<LotteryProduct> LotteryProducts { get; set; }
    public DbSet<ApplicationOrder> ApplicationOrders { get; set; }
    public DbSet<PrintingOrder> PrintingOrders { get; set; }
    public DbSet<LogisticsInfo> LogisticsInfos { get; set; }
    public DbSet<ApprovalRecord> ApprovalRecords { get; set; }
}
```

**Repository 模式**：
- 每个实体对应一个 Repository
- 使用 UnitOfWork 管理事务

## 三、数据库设计

### 3.1 核心数据表

**用户表（Users）**：
```sql
CREATE TABLE Users (
    Id BIGINT PRIMARY KEY AUTO_INCREMENT,
    OpenId VARCHAR(100) UNIQUE NOT NULL,
    NickName VARCHAR(100),
    AvatarUrl VARCHAR(500),
    Role ENUM('Admin', 'LotteryCenter', 'PrintingFactory', 'SalesOutlet'),
    OrganizationId BIGINT,
    Status TINYINT DEFAULT 1,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**彩票产品表（LotteryProducts）**：
```sql
CREATE TABLE LotteryProducts (
    Id BIGINT PRIMARY KEY AUTO_INCREMENT,
    ProductName VARCHAR(200) NOT NULL,
    ProductCode VARCHAR(50) UNIQUE NOT NULL,
    LotteryCenterId BIGINT NOT NULL,
    TotalQuantity INT NOT NULL,
    AvailableQuantity INT NOT NULL,
    Price DECIMAL(10,2),
    Description TEXT,
    Status TINYINT DEFAULT 1,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_lottery_center (LotteryCenterId),
    INDEX idx_status (Status)
);
```

**申请订单表（ApplicationOrders）**：
```sql
CREATE TABLE ApplicationOrders (
    Id BIGINT PRIMARY KEY AUTO_INCREMENT,
    OrderNo VARCHAR(50) UNIQUE NOT NULL,
    ProductId BIGINT NOT NULL,
    SalesOutletId BIGINT NOT NULL,
    RequestedQuantity INT NOT NULL,
    ApprovedQuantity INT,
    Status ENUM('Pending', 'Approved', 'Rejected', 'WaitingShipment', 'Shipped', 'InTransit', 'Completed'),
    ShippingAddress VARCHAR(500),
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_product (ProductId),
    INDEX idx_outlet (SalesOutletId),
    INDEX idx_status (Status)
);
```

### 3.2 数据库索引策略

- 为外键字段添加索引
- 为常用查询条件字段添加索引
- 为状态字段添加索引
- 考虑使用复合索引优化多条件查询

## 四、接口设计

### 4.1 API规范

**统一响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

**错误码规范**：
- 200：成功
- 400：请求参数错误
- 401：未授权
- 403：无权限
- 404：资源不存在
- 500：服务器内部错误

### 4.2 核心接口示例

**用户登录接口**：
```
POST /api/v1/auth/login
Request: { "code": "wx_login_code" }
Response: { "code": 200, "data": { "token": "jwt_token", "userInfo": {...} } }
```

**产品列表接口**：
```
GET /api/v1/products?page=1&pageSize=10
Response: { "code": 200, "data": { "items": [...], "total": 100 } }
```

**创建申请订单接口**：
```
POST /api/v1/orders/application
Request: { "productId": 1, "quantity": 100, "address": "..." }
Response: { "code": 200, "data": { "orderId": 123, "orderNo": "..." } }
```

## 五、安全方案

### 5.1 认证授权

- **JWT Token**：有效期24小时，支持刷新
- **网关验证**：所有请求在网关层验证token
- **服务验证**：服务层验证用户角色权限
- **密码加密**：使用BCrypt加密存储

### 5.2 数据安全

- **SQL注入防护**：使用参数化查询
- **XSS防护**：前端输入过滤和转义
- **HTTPS**：生产环境强制使用HTTPS
- **敏感数据加密**：手机号、身份证等敏感信息加密存储

### 5.3 接口安全

- **限流**：网关层限流，防止恶意请求
- **签名验证**：关键接口使用签名验证
- **日志审计**：记录所有关键操作日志

## 六、性能优化方案

### 6.1 缓存策略

- **Redis缓存**：缓存热点数据（产品信息、用户信息）
- **缓存过期**：设置合理的过期时间
- **缓存更新**：数据变更时主动更新缓存
- **缓存穿透**：使用布隆过滤器防止缓存穿透

### 6.2 数据库优化

- **索引优化**：为常用查询添加索引
- **分页查询**：所有列表查询必须分页
- **连接池**：配置合理的数据库连接池
- **慢查询监控**：监控并优化慢查询

### 6.3 代码优化

- **异步处理**：耗时操作使用异步处理
- **批量操作**：减少数据库往返次数
- **对象池**：复用对象，减少GC压力

## 七、开发规范

### 7.1 代码规范

- 遵循C#编码规范（Microsoft C# Coding Conventions）
- 使用EditorConfig统一代码格式
- 使用StyleCop进行代码检查

### 7.2 Git规范

- 分支策略：Git Flow
- 提交消息：`<type>(<scope>): <subject>`
- 代码审核：所有代码必须经过Code Review

### 7.3 测试规范

- 单元测试覆盖率：核心业务逻辑≥80%
- 集成测试：测试关键业务流程
- 性能测试：上线前进行压力测试

---

**文档版本**：1.0
**最后更新**：2026-01-18
